<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Open+Sans:wght@400;700&display=swap">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Open Sans', Arial, sans-serif;
            background-color: #f0f0f0;
            color: #000000;
        }

        header {
            background-color: #201444;
            color: #ffffff;
            padding: 20px;
            text-align: center;
        }

        h1 {
            font-size: 28px;
        }

        .admin-content {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .admin-section {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }

        .admin-section h2 {
            margin-top: 0;
            font-size: 24px;
        }

        .admin-section label {
            font-size: 18px;
            display: block;
            margin-bottom: 5px;
        }

        .admin-section input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .admin-section button[type="submit"] {
            font-size: 16px;
            background-color: #3498db;
            color: #ffffff;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Roboto', Arial, sans-serif;
        }

        .admin-section button[type="submit"]:hover {
            background-color: #2980b9;
        }

        .logout-button {
            font-size: 16px;
            background-color: #3498db;
            color: #ffffff;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Roboto', Arial, sans-serif;
            margin-top: 10px;
        }

        .logout-button:hover {
            background-color: #2980b9;
        }

        .admin-section label,
        .admin-section input[type="text"],
        .admin-section button[type="submit"] {
            display: block;
            width: 100%;
        }

        .admin-section input[type="text"],
        .admin-section textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 15px;
            box-sizing: border-box;
            /* Add this line to include padding and border in the width */
        }

        .autocomplete-suggestion {
            cursor: pointer;
            padding: 5px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            margin: 2px;
        }
    </style>
</head>

<body>
    <header>
        <h1>Admin Dashboard</h1>
        <button class="logout-button" onclick="logout()">Logout</button>
    </header>
    <div class="admin-content">
        <div class="admin-section">
            <h2>Message Sender</h2>
            <form id="messageForm">
                <label for="channelSelect">Select a Channel:</label>
                <select id="channelSelect" name="channelId" required></select>
                <label for="message">Message:</label>
                <textarea id="message" name="message" rows="5" required></textarea>
                <button type="submit">Send Message</button>
                <div id="autocomplete-suggestions"></div>
            </form>
        </div>
        <!-- Add more admin sections as needed -->
    </div>

    <script>
        function logout() {
            // Send a request to the server to perform logout
            fetch('/logout')
                .then((response) => {
                    // After logout, redirect to the login page
                    window.location.href = 'https://iconicticket.muralianand.in'; // Replace '/login' with the URL of your login page
                })
                .catch((error) => {
                    console.error('Error during logout:', error);
                    // If there's an error during logout, you can still redirect to the login page
                    window.location.href = 'https://iconicticket.muralianand.in'; // Replace '/login' with the URL of your login page
                });
        }

        async function fetchFileCount() {
            try {
                const response = await fetch('/filecount');
                const data = await response.json();
                console.log('File count:', data.fileCount);
            } catch (error) {
                console.error('Error fetching file count:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchFileCount();
            const messageForm = document.getElementById('messageForm');
            messageForm.addEventListener('submit', submitMessageForm);
            fetchInitialData();
        });

        async function submitMessageForm(event) {
            event.preventDefault();

            const channelId = document.getElementById('channelSelect').value;
            const message = document.getElementById('message').value;

            try {
                const response = await fetch('/sendmessage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ channelId, message })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Message sent successfully!');
                } else {
                    alert('Failed to send message. Please try again.');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('An error occurred while sending the message. Please try again later.');
            }
        }

        async function fetchChannelsOption() {
            try {
                const response = await fetch('/getchannels');
                const channels = await response.json();
                const channelSelect = document.getElementById('channelSelect');
                channelSelect.innerHTML = '';

                channels.forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel.id;
                    option.text = channel.name;
                    channelSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching channels:', error);
            }
        }

        fetchChannelsOption();

        const messageTextarea = document.getElementById('message');
        const autocompleteSuggestions = document.getElementById('autocomplete-suggestions');

        const availableRoles = [];
        const availableChannels = [];
        const availableUsers = [];

        async function fetchRoles() {
            try {
                const response = await fetch('/getroles');
                const roles = await response.json();

                availableRoles.length = 0; // Clear existing array
                roles.forEach(role => {
                    availableRoles.push({ id: role.id, name: role.name });
                });
            } catch (error) {
                console.error('Error fetching roles:', error);
            }
        }

        async function fetchChannels() {
            try {
                const response = await fetch('/getchannels');
                const channels = await response.json();

                availableChannels.length = 0; // Clear existing array
                channels.forEach(channel => {
                    availableChannels.push({ id: channel.id, name: channel.name });
                });
            } catch (error) {
                console.error('Error fetching channels:', error);
            }
        }

        async function fetchUsers() {
            try {
                const response = await fetch('/getusers');
                const users = await response.json();

                availableUsers.length = 0; // Clear existing array
                users.forEach(user => {
                    availableUsers.push({ id: user.id, username: user.username });
                });
            } catch (error) {
                console.error('Error fetching users:', error);
            }
        }

        async function fetchInitialData() {
            try {
                await fetchRoles();
                await fetchChannels();
                await fetchUsers();
            } catch (error) {
                console.error('Error fetching initial data:', error);
            }
        }

        messageTextarea.addEventListener('input', function () {
            const content = messageTextarea.value;
            const cursorPosition = messageTextarea.selectionStart;
            const typedText = content.substring(0, cursorPosition).split(' ').pop();

            // Clear existing suggestions
            autocompleteSuggestions.innerHTML = '';

            if (typedText.startsWith('#')) {
                showSuggestions(availableChannels, typedText.substring(1));
            } else if (typedText.startsWith('@')) {
                showSuggestions(availableUsers, typedText.substring(1));
            } else if (typedText.startsWith('@&')) {
                showSuggestions(availableRoles, typedText.substring(2));
            }
        });


        function showSuggestions(availableItems, typedText) {
            const matchedItems = availableItems.filter(item =>
                item.name.toLowerCase().includes(typedText.toLowerCase())
            );

            autocompleteSuggestions.innerHTML = '';

            matchedItems.forEach(matchedItem => {
                const suggestion = document.createElement('div');
                suggestion.className = 'autocomplete-suggestion';
                suggestion.textContent = matchedItem.name;
                autocompleteSuggestions.appendChild(suggestion);
            });

            autocompleteSuggestions.addEventListener('click', (event) => {
                const clickedSuggestion = event.target.textContent;
                const currentContent = messageTextarea.value;
                const cursorPosition = messageTextarea.selectionStart;
                const typedText = currentContent.substring(0, cursorPosition).split(' ').pop();
                const prefix = currentContent.substring(0, cursorPosition - typedText.length);
                const suffix = currentContent.substring(cursorPosition);

                let mentionText = '';

                if (typedText.startsWith('#')) {
                    const channelId = getChannelIdFromName(clickedSuggestion);
                    if (channelId) {
                        mentionText = `<#${channelId}> `;
                    }
                } else if (typedText.startsWith('@')) {
                    const userId = getUserIdFromName(clickedSuggestion);
                    if (userId) {
                        mentionText = `<@${userId}> `;
                    }
                } else if (typedText.startsWith('@&')) {
                    const roleId = getRoleIdFromName(clickedSuggestion);
                    if (roleId) {
                        mentionText = `<@&${roleId}> `;
                    }
                }

                messageTextarea.value = prefix + mentionText + suffix;
                messageTextarea.focus();
                autocompleteSuggestions.innerHTML = '';
            });
        }

        function getChannelIdFromName(channelName) {
            const channel = availableChannels.find(channel => channel.name.toLowerCase() === channelName.toLowerCase());
            return channel ? channel.id : null;
        }

        function getUserIdFromName(userName) {
            const user = availableUsers.find(user => user.username.toLowerCase() === userName.toLowerCase());
            return user ? user.id : null;
        }

        function getRoleIdFromName(roleName) {
            const role = availableRoles.find(role => role.name.toLowerCase() === roleName.toLowerCase());
            return role ? role.id : null;
        }

    </script>
</body>

</html>